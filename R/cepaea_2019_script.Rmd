---
title: *Cepaea* polymorphism and parasites
author: "Armelle Ansart, Claudia Gérard, Marine Proux, Maxime Dahirel (this code by M. Dahirel)"
date:
output: 
  html_document:
    theme: yeti
    toc: TRUE
    toc_float: TRUE
editor_options:
  chunk_output_type: console
bibliography:
csl:
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = FALSE, message = FALSE)
```


# A brief introduction

<!--to do-->

"Nematode, but not trematode, infection negatively affect Cepaea nemoralis activity"
good, but miss the morph effect
"Nematode infection is morph-dependent and negatively affect Cepaea nemoralis behaviour"
good but miss the trematode presence and its absence of effect

# Part 1 : Preparation

## 1A - packages

```{r packages-loading}
#library(rstan) ## Stan backend
library(cmdstanr) ## Stan backend (another)
library(brms) ## the interface we are using

library(tidyverse)
library(bayesplot)
library(tidybayes)
library(matrixStats)

library(QGglmm) ## this package is needed to help convert variance-covariance matrices from latent to data scale

library(patchwork) #plotting

library(here)

## some useful default settings
rstan_options(auto_write = TRUE) #for rstan
options(mc.cores = 2) ## reduce/increase depending on cores available
N_chains <- 4
N_warmup <- 100 
N_iter <- N_warmup + 100 
```


## 1B – data loading and wrangling

```{r data-load}
data_behaviour <- read_csv(here("data","cepaea_2019_behaviour.csv"))
data_parasite <- read_csv(here("data","cepaea_2019_parasite.csv"))
```


```{r}
#### don't forget removing the dead one when relevant
data_para<-data_parasite %>% 
  mutate(Nematode_live_all = data_parasite %>% select(Nematode_0_1_free:Nematode_5_plus_lung) %>% rowSums()) %>% 
  mutate(Nematode_encaps_all = Nematode_white_encaps + Nematode_dark_encaps)



data<-left_join(data_behaviour,data_para) %>% 
  filter(dead==0) %>% #remove the dead individual from the dataset THIS IS THE ONE WITH THE MOST NEMATOD BY FAR (102), this is NAT HISTORY INFO
  mutate(is.shaded = as.numeric(population=="shaded")-mean(as.numeric(population=="is.shaded"))) %>% 
  mutate(mvt = (1/(FPT3-FPT1)),
         food = scale(Food_intake)[,1],
         scale_size = scale(shell_diameter)[,1]) %>% 
  mutate(mvt = replace(mvt,which(FPT1>=1200),0)) %>% 
  mutate(mvt=scale(mvt)[,1])  ##first approx, include inactive in estimates of scaling
## individuals with fpt1>=1200 are NOT active, so should not count towards mvt model
## is time to activity itself actually a relevant variable? NO (not stdised in the petri to, table phase, just let them habituate until they move)


bf_trema<-bf(Trematode_kidney|subset(session==1) ~ is.shaded * ( band_number + fusion) + scale_size + (1|series)+(1|q|fullID),family=poisson)
bf_nemaL<-bf(Nematode_live_all|subset(session==1 & population=="sun_exposed") ~ band_number + fusion + scale_size + (1|series)+(1|q|fullID),family=poisson)
bf_food<-bf(food ~  is.shaded * (band_number + fusion) + scale_size + (1|series)+(1|q|fullID))
bf_mvt<-bf(mvt|subset(FPT1 < 1200) + cens(-1*(FPT3>=1200)) ~  is.shaded * (band_number + fusion) + scale_size + (1|series)+(1|q|fullID))

##group column is actually just lettercode, worth renaming removing?
## true grouping variable is series, snails boxed by band*landscape, 10 of each taken in series, then replaced in box before second test

mod<-brm(mvbf(bf_food+bf_trema+bf_nemaL+bf_mvt),
           data=data,
        chains=4,iter=2000,warmup=1000,
        prior=c(set_prior("normal(0,1)",class="Intercept",resp=c("Trematodekidney","Nematodeliveall")),
                set_prior("normal(0,1)",class="Intercept",resp=c("food","mvt")),
                set_prior("normal(0,1)",class="b",resp=c("Trematodekidney","Nematodeliveall","food","mvt")),
                set_prior("normal(0,1)", class="sd",resp=c("Trematodekidney","Nematodeliveall","food","mvt")),
                #set_prior("constant(0.01)",class="sigma",resp="scalesize"),
                set_prior("normal(0,1)",class="sigma",resp=c("mvt","food")),
                set_prior("lkj(2)",class="cor")),
        backend="cmdstanr",seed=42,control=list(adapt_delta=0.99,max_treedepth=10))

## what about rescor between food and mvt if gaussian
## two reasons not possible: for rescor, all traits need to be gaussian in the multivar model
## if i do a sep model with just food and mvt, error because rescor doesn't allow for cens or subset aterms (only se mi and weights)

### for enkysted nematodes: cannot analyse total N because probably accrue with age, which we do not know here
### compare proportion of in black versus in white would probs need to know actual surface of each (+ bias towards trapping close to opening, where more black), so just natural history and evidence that nematodes are present in marais, just not when we sampled (seasonality?)

data_para$is.shaded = as.numeric(data_para$population=="shaded")-mean(as.numeric(data_para$population=="is.shaded"))
data_para$scale_size = scale(data_para$shell_diameter)[,1]

mod_history<-brm(Nematode_encaps_all>0 ~ is.shaded * ( band_number + fusion ) + scale_size,family=bernoulli,
         data=data_para, chains=4, iter=2000, warmup=1000,
         prior=c(set_prior("normal(0,1.5)",class="Intercept"),
                 set_prior("normal(0,1)",class="b")),
         backend="cmdstanr",seed=42)

# ideally would include size as a correlated response in the multivar, not a covariate, but splitting indvar bw sigma and SD is WAY TOO HARD
mod_size <-brm(bf(scale_size|subset(session==1) ~ is.shaded * ( band_number + fusion )),
         data=data, chains=4, iter=2000, warmup=1000,
         prior=c(
           set_prior("normal(0,1)",class="Intercept"),
           set_prior("normal(0,1)",class="b"),
           set_prior("normal(0,1)",class="sigma")),
         backend="cmdstanr",seed=42,control=list(max_treedepth=20))


#5band smaller in shaded but not sunshaded
#if correct result, possible interpretations
# actually smaller adult, early maturity (but why 5 only)
# small adult 5 survive more in shaded
# revisit old data from eric to confirm??

## pattern same in old cornu data (arcaisCornupheno in phd folder) intermediate vs ferme, ouvert is vineyard (no cepaea there), so something cross specific and cross temp
```

"in addition to our variables of interest, we collected data on total body mass at marking (including shell), shell mass, whether encapsulated nematodes were found in darker or clearer parts of the shell, and how sorted live nematodes into rough size classes and locations. These ancillary data are not used in analyses, but made available along variables of interest in online dataset, for completion's sake."

idea that no nematode in shaded, nematodes in sun: seasonality?
certainly not absence since nematodes found in shells at similar proportion in both
nematodes when present seem to depend on morph, in ways consistent with melanin immunity effect (but band not melanin, and 0 fusion effect)
nematodes have individual effect on behaviour, but not trematodes? immunity? life history

discuss (non)implication of no association bw trematode and shell for selection by birds and bird-snail-parasite interactions

morph level effect: intersting to see that when going from non-infected to infected pop, 5band don't chnage their behaviour
but 0 band become less mobile

more feeding in shaded, consistent with correlation feeding-nematode in sun exposed :)

confounding pop and infection, more study to do cross pop and cross season
why no effect of pop in previous cepaea on same site: seasonaility: snails in prevous paper kept much longer in lab, and it appears that snails can clear nematodes effectively with time (given absence in shaded now)

suggestion: experiment on snails directly from field at several times of the year (seasonaility of infection)
confirm that stay in lab can clear parasite with time
use experimental infection (look at lit on cepaea/phasmarhab)