---
title: *Cepaea* polymorphism and parasites
author: "Armelle Ansart, Claudia Gérard, Marine Proux, Maxime Dahirel (this code by M. Dahirel)"
date:
output: 
  html_document:
    theme: yeti
    toc: TRUE
    toc_float: TRUE
editor_options:
  chunk_output_type: console
bibliography:
csl:
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = FALSE, message = FALSE)
```


# A brief introduction

<!--to do-->

# Part 1 : Preparation

## 1A - packages

```{r packages-loading}
#library(rstan) ## Stan backend
library(cmdstanr) ## Stan backend (another)
library(brms) ## the interface we are using

library(tidyverse)
library(bayesplot)
library(tidybayes)
library(matrixStats)
library(patchwork) #plotting

library(here)

## some useful default settings
#rstan_options(auto_write = TRUE) #for rstan
options(mc.cores = 4) ## reduce/increase depending on cores available
```


## 1B – data loading and wrangling

```{r data-load}
raw_behaviour <- read_csv(here("data","cepaea_2019_behaviour.csv"))
raw_parasite <- read_csv(here("data","cepaea_2019_parasite.csv"))
```


```{r data-prep}
#### don't forget removing the dead one when relevant
data_parasite<-raw_parasite %>% 
  mutate(Nematode_live_all = raw_parasite %>% 
           select(c(Nematode_0_1_free, Nematode_1_3_free, 
                    Nematode_3_5_free, Nematode_5_plus_free, 
                    Nematode_1_3_lung, Nematode_3_5_lung, 
                    Nematode_5_plus_lung)) %>% 
           rowSums()) %>% 
  mutate(Nematode_encaps_all = Nematode_white_encaps + Nematode_dark_encaps)



data <- left_join(raw_behaviour,data_parasite) %>% 
  filter(dead==0) %>% 
  #remove the dead individual from the dataset 
  #!!THIS IS THE ONE WITH THE MOST NEMATODES BY FAR (102), this is natural history info to not forget
  #we then standardize covariates
  mutate(is.shaded = as.numeric(population=="shaded")-mean(as.numeric(population=="is.shaded")),
         scale_size = scale(shell_diameter)[,1]) %>% 
  mutate(mean_size=mean(shell_diameter,na.rm=TRUE),
         sd_size=sd(shell_diameter,na.rm=TRUE)) %>% 
  mutate(mean_food=mean(Food_intake,na.rm=TRUE),
         sd_food=sd(Food_intake,na.rm=TRUE)) %>% 
  mutate(scale_food = scale(Food_intake)[,1]) %>% 
  mutate(population = fct_relevel(factor(population),"shaded",after=Inf)) %>% 
  mutate(population2 = fct_recode(population,
                                  `shaded habitat` = "shaded",
                                  `open habitat` = "sun_exposed")) %>% 
  mutate(population3 = fct_recode(population,
                                  `shaded habitat (nematode-free)` = "shaded",
                                  `open habitat (nematodes)` = "sun_exposed"))
```


```{r data-prep-mvt}
#we then define our movement variable
data <- data %>% 
  mutate(FPT1 = FPT1/60, ## let's just convert them to minutes
         FPT2 = FPT2/60,
         FPT3 = FPT3/60) %>% 
  mutate(has.moved = FPT1 < 20) %>% 
  mutate(mvt = (1/(FPT3-FPT1))) %>% 
  mutate(mvt = replace(mvt,which(has.moved == FALSE),0)) %>% 
  # put a zero for the ones that don't move
  mutate(mean_mvt = mean(subset(mvt,has.moved ==TRUE)), ##mean and sd for scaling
         sd_mvt = sd(subset(mvt,has.moved ==TRUE))) %>% ## exclude not moving individuals
  mutate(scale_mvt = (mvt - mean_mvt)/sd_mvt)
## individuals with fpt1>=20 minutes are NOT active, so should not count towards mvt model
## is time to activity itself actually a relevant variable? NO (not stdised in the petri to, table phase, just let them habituate until they move)
```

See the model tests script for why we choose these transformations for movement and food intake data

# model 

```{r}
bf_trema<-bf(
  Trematode_kidney|subset(session==1) ~ 
    is.shaded * ( band_number + fusion) + scale_size + 
    (1|series)+(1|q|fullID),
  family=poisson)

bf_nema_live<-bf(
  Nematode_live_all|subset(session==1 & population=="sun_exposed") ~ 
    band_number + fusion + scale_size + 
    (1|series)+(1|q|fullID),
  family=poisson)

bf_food<-bf(scale_food ~  is.shaded * (band_number + fusion) + scale_size + 
              (1|series)+(1|q|fullID))

bf_mvt<-bf(
  scale_mvt|subset(has.moved==TRUE) + cens(-1*(FPT3>=20)) ~  
    is.shaded * (band_number + fusion) + scale_size + 
    (1|series)+(1|q|fullID))

##group column is actually just lettercode, worth renaming removing?
## true grouping variable is series, snails boxed by band*landscape, 10 of each taken in series, then replaced in box before second test

mod<-brm(mvbf(bf_food+bf_trema+bf_nema_live+bf_mvt),
           data=data,
        chains=4,iter=4000,warmup=2000,
        prior=c(set_prior("normal(0,1)",class="Intercept",resp=c("Trematodekidney","Nematodeliveall")),
                set_prior("normal(0,1)",class="Intercept",
                          resp=c("scalefood","scalemvt")),
                set_prior("normal(0,1)",class="b",
                          resp=c("Trematodekidney","Nematodeliveall","scalefood","scalemvt")),
                set_prior("normal(0,1)", class="sd",
                          resp=c("Trematodekidney","Nematodeliveall","scalefood","scalemvt")),
                #set_prior("constant(0.01)",class="sigma",resp="scalesize"),
                set_prior("normal(0,1)",class="sigma",resp=c("scalemvt","scalefood")),
                set_prior("lkj(2)",class="cor")),
        backend="cmdstanr",seed=42,control=list(adapt_delta=0.99,max_treedepth=10))
```


```{r}
### for enkysted nematodes: cannot analyse total N because probably accrue with age, which we do not know here
### to compare proportion of in black versus in white would probs need to know actual surface of each (+ bias towards trapping close to opening, where more black), 

### so what we can do: use presence absence data as just natural history and evidence that nematodes are present in marais, just not when we sampled (seasonality?)

mod_history<-brm(Nematode_encaps_all>0 | subset(session == 1)~ is.shaded * ( band_number + fusion ) + scale_size,family=bernoulli,
         data=data, chains=4, iter=2000, warmup=1000,
         prior=c(set_prior("normal(0,1.5)",class="Intercept"),
                 set_prior("normal(0,1)",class="b")),
         backend="cmdstanr",seed=42)
## add random effect of series??? (or remove it from nema/trema??)
```


```{r}
# ideally would include size as a correlated response in the multivar, not a covariate, but splitting indvar bw sigma and SD is WAY TOO HARD
mod_size <-brm(bf(scale_size|subset(session==1) ~ is.shaded * ( band_number + fusion )),
         data=data, chains=4, iter=2000, warmup=1000,
         prior=c(
           set_prior("normal(0,1)",class="Intercept"),
           set_prior("normal(0,1)",class="b"),
           set_prior("normal(0,1)",class="sigma")),
         backend="cmdstanr",seed=42,control=list(max_treedepth=20))

#5band smaller in shaded but not sunshaded
#if correct result, possible interpretations
# actually smaller adult, early maturity (but why 5 only)
# small adult 5 survive more in shaded
# revisit old data from eric to confirm??

## pattern same in old cornu data (arcaisCornupheno in phd folder) intermediate vs ferme, ouvert is vineyard (no cepaea there), so something cross specific and cross temp
```

```{r}
preds_size <- data %>% 
  select(band_number,is.shaded,population, population2,mean_size,sd_size) %>% 
  distinct() %>% 
  mutate(session=1,fusion="no") %>% 
  add_fitted_draws(mod_size,re_formula=NA) %>%  ## but re_formula NA not right for poisson ORLE, right? at least not for mean
  ungroup()

ggplot(subset(data,dead==0 & session==1)) +
  geom_jitter(aes(band_number,shell_diameter),height=0,col="grey")+
  stat_eye(data=preds_size, aes(band_number,(.value*sd_size)+mean_size, fill=band_number),.width=c(0.01,0.95),slab_alpha=0.7)+
  scale_y_continuous("Shell diameter (mm)") +
  scale_x_discrete("Shell phenotype (band number)",labels=c("0 bands","3 bands","5 bands"))+
  scale_fill_manual(values=c("#fe9929","#d95f0e","#993404")) +
  facet_wrap(~population2) +
  cowplot::theme_half_open(11) +
  cowplot::background_grid(colour.major = "grey95", colour.minor = "grey95") + 
  theme(legend.position="none")
```


```{r}
preds_encaps <- data %>% 
  select(band_number,is.shaded,population, population2) %>% 
  distinct() %>% 
  mutate(scale_size=0, session=1,fusion="no") %>% 
  add_fitted_draws(mod_history,re_formula=NA) %>%
  ungroup()

p_encaps <- ggplot() +
  geom_col(data=data %>% 
             group_by(population2,band_number) %>% 
             filter(dead==0 & session==1) %>% 
             summarise(percent_encaps=mean(Nematode_encaps_all>0)*100) %>% ungroup(),
           aes(band_number,percent_encaps),fill="white",col="grey")+
  stat_eye(data=preds_encaps, aes(band_number,.value*100, fill = band_number),.width=c(0.01,0.95),slab_alpha=0.7)+
  scale_y_continuous("% with encapsulated nematodes")+
  scale_x_discrete("",labels=c("0 bands","3 bands","5 bands"))+
  scale_fill_manual(values=c("#fe9929","#d95f0e","#993404")) +
  facet_wrap(~population2)+
  coord_cartesian(ylim=c(0,100))

preds_nematode <- data %>% 
  select(band_number) %>% 
  distinct() %>% 
  mutate(scale_size=0, session=1,fusion="no", population="sun_exposed", population2 = "open habitat") %>% 
  add_fitted_draws(mod,re_formula=NA,resp="Nematodeliveall") %>%  ## but re_formula NA not right for poisson ORLE, right? at least not for mean
  ungroup()

p_nema <- ggplot(subset(data,dead==0 & session==1)) +
  geom_jitter(aes(band_number,Nematode_live_all),height=0, col="grey")+
  stat_eye(data=preds_nematode, aes(band_number,.value, fill = band_number),.width=c(0.01,0.95),slab_alpha=0.7)+
  scale_y_continuous("Nematodes")+
  scale_x_discrete("",labels=c("0 bands","3 bands","5 bands"))+
  scale_fill_manual(values=c("#fe9929","#d95f0e","#993404")) +
  facet_wrap(~population2)

preds_trematode <- data %>% 
  select(band_number,is.shaded,population, population2) %>% 
  distinct() %>% 
  mutate(scale_size=0, session=1,fusion="no") %>% 
  add_fitted_draws(mod,re_formula=NA,resp="Trematodekidney") %>%  ## but re_formula NA not right for poisson ORLE, right? at least not for mean
  ungroup()

p_trema <- ggplot(subset(data,dead==0 & session==1)) +
  geom_jitter(aes(band_number,Trematode_kidney),height=0,col="grey")+
  stat_eye(data=preds_trematode, aes(band_number,.value, fill=band_number),.width=c(0.01,0.95),slab_alpha=0.7)+
  scale_y_continuous("Trematodes in kidney") +
  scale_x_discrete("Shell phenotype (band number)",labels=c("0 bands","3 bands","5 bands"))+
  scale_fill_manual(values=c("#fe9929","#d95f0e","#993404")) +
  facet_wrap(~population2)

p_encaps/p_nema/p_trema & 
  cowplot::theme_half_open(11) &
  cowplot::background_grid(colour.major = "grey95", colour.minor = "grey95") & 
  theme(legend.position="none")

```

absence of effect of trematodes may be due to rarity in overall population (what happens in more infected pops, see refs)


```{r}
preds_mvt <- data %>% 
  select(population,population3,band_number, is.shaded,mean_mvt,sd_mvt) %>% 
  distinct() %>% 
  mutate(scale_size=0, session=1, FPT3=0, FPT1=0,fusion="no",has.moved=TRUE) %>% 
  add_fitted_draws(mod,re_formula=NA,resp="scalemvt") %>% 
  mutate(.value=.value*sd_mvt + mean_mvt)


p_mvt <- ggplot(subset(data,has.moved==TRUE)) +
    geom_line(aes(as.numeric(factor(band_number))+0.5*session-0.75,mvt,group=fullID),col="grey")+
    geom_point(aes(band_number,mvt,pch=FPT3==20,group=session),position=position_dodge(width=1),col="grey",fill="white")+
    stat_eye(data=preds_mvt,aes(band_number,.value,fill=band_number),
           .width=c(0.01,0.95),slab_alpha=0.7)+
  scale_shape_manual(values=c(16,21))+
  scale_fill_manual(values=c("#fe9929","#d95f0e","#993404")) +
  scale_y_continuous("Movement speed (unit/min)")+
  scale_x_discrete("",labels=c("0 bands","3 bands","5 bands"))+
    facet_wrap(~population3) 



preds_food <- data %>% 
  select(population,population2,band_number, is.shaded,mean_food,sd_food) %>% 
  distinct() %>% 
  mutate(scale_size=0, session=1,fusion="no") %>% 
  add_fitted_draws(mod,re_formula=NA,resp="scalefood") %>% 
  mutate(.value=.value*sd_food + mean_food)

p_food <- ggplot(data) +
    geom_point(aes(band_number,Food_intake,group=session),position=position_dodge(width=1),col="grey")+
    geom_line(aes(as.numeric(factor(band_number))+0.5*session-0.75,Food_intake,group=fullID),col="grey")+
    stat_eye(data=preds_food,aes(band_number,.value,fill=band_number),
           .width=c(0.01,0.95),slab_alpha=0.7)+
  scale_fill_manual(values=c("#fe9929","#d95f0e","#993404")) +
  scale_y_continuous("Food intake (g/night)")+
  scale_x_discrete("Shell phenotype (band number)",labels=c("0 bands","3 bands","5 bands"))+
    facet_wrap(~population3)

p_mvt/p_food & 
  cowplot::theme_half_open(11) &
  cowplot::background_grid(colour.major = "grey95", colour.minor = "grey95") & 
  theme(legend.position="none")
```



no need of complex stuff for repeatabilities, the two repeatable traits are gaussian here

```{r}
## expressed on scale components but OK because we plot % of variance
varcomps_mvt <- tibble(
  VF = rowVars(posterior_linpred(mod, re_formula = NA,resp="scalemvt")),
  VI = VarCorr(mod,summary=FALSE)$fullID$sd[,"scalemvt_Intercept"]^2,
  Vseries = VarCorr(mod,summary=FALSE)$series$sd[,"scalemvt_Intercept"]^2,
  VR =(posterior_samples(mod,pars="sigma_scalemvt")[,1])^2
) %>% 
mutate(trait="mvt",
       VP = VF + VI + Vseries + VR)

varcomps_food <- tibble(
  VF = rowVars(posterior_linpred(mod, re_formula = NA,resp="scalefood")),
  VI = VarCorr(mod,summary=FALSE)$fullID$sd[,"scalefood_Intercept"]^2,
  Vseries = VarCorr(mod,summary=FALSE)$series$sd[,"scalefood_Intercept"]^2,
  VR =(posterior_samples(mod,pars="sigma_scalefood")[,1])^2
) %>% 
mutate(trait="food",
       VP = VF + VI + Vseries + VR)

rbind(varcomps_food,varcomps_mvt) %>% 
  group_by(trait) %>% 
  pivot_longer(cols=c(VF, VI, Vseries, VR),names_to = "varcomp" , values_to = "variance") %>% 
  ggplot()+
  stat_halfeye(aes(y=varcomp,x=100*variance/VP),
                point_interval = mean_hdi,.width = c(0.001,0.95),
                normalize="xy")+
  facet_wrap(~trait)+
  scale_x_continuous(name="Variance explained (%, observed scale)", lim=c(0,100),
                     breaks=seq(from=0,to=100,by=10))+
  scale_y_discrete(name="Variance component") +
  cowplot::theme_half_open(11) +
  cowplot::background_grid(colour.major = "grey95",colour.minor = "grey95")
  
```

```{r}
VarCorr(mod)$fullID$cov
```


 + individual level correlation grid to do

