---
title: 'Supplementary Material for "Morph-dependent effect of nematode infection on host movement in the land snail *Cepaea nemoralis* (Mollusca, Gastropoda)"'
author: "Maxime Dahirel, Marine Proux, Armelle Ansart, Claudia GÃ©rard"
date:
output: pdf_document
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE, warning = FALSE,
  message = FALSE, eval = TRUE, dev = "cairo_pdf"
)
```

```{r packages-loading}
library(matrixStats) # CRAN v0.61.0

library(cmdstanr) # [github::stan-dev/cmdstanr] v0.4.0.9000
library(brms) # CRAN v2.16.3

library(tidyverse) # CRAN v1.3.1

library(bayesplot) # CRAN v1.8.1
library(tidybayes) # CRAN v3.0.2

library(patchwork) # CRAN v1.1.1

library(here) # CRAN v1.0.1

options(mc.cores = 4) ## to reduce/increase depending on cores available on your machine
```


# S1 - detailed math description of both models

## Size model


## Multivariate model of parasites abundance and snail behaviours


# S2 - descriptive stats about parasites 

```{r data-load}
raw_parasite <- read_csv(here("data", "cepaea_2019_parasite.csv"))

data_parasite <- raw_parasite %>%
  mutate(population = fct_relevel(factor(population), "shaded", after = Inf)) %>% # factor reordering
  mutate(Nematode_live_all = Nematode_0_1_free + Nematode_1_3_free +
           Nematode_3_5_free + Nematode_5_plus_free + Nematode_1_3_lung + 
           Nematode_3_5_lung + Nematode_5_plus_lung,
         Nematode_encaps_all = Nematode_white_encaps + Nematode_dark_encaps,
         Acari_live_all = Acari_kidney + Acari_digestive
         ) %>% 
  mutate(session = 1)
```

(morph and population specific prevalence, as well as min/mean/median/max CI abundance and/or intensities)




```{r}
data_parasite %>%
  group_by(population, band_number, dead) %>%
  summarise(
    preva_trema = mean(Trematode_kidney > 0),
    preva_nema = mean(Nematode_live_all > 0),
    preva_nencaps = mean(Nematode_encaps_all > 0),
    preva_acari = mean(Acari_live_all > 0),
    preva_aaencaps = mean(Acari_encaps > 0),
    abun_trema = mean(Trematode_kidney),
    abun_nema = mean(Nematode_live_all),
    abun_nencaps = mean(Nematode_encaps_all),
    abun_acari = mean(Acari_live_all),
    abun_aencaps = mean(Acari_encaps)
  )


data_parasite %>%
  group_by(population, band_number, dead) %>%
  filter(Trematode_kidney > 0) %>%
  summarise(
    N = length(Trematode_kidney),
    min_inci = min(Trematode_kidney),
    median_inci = median(Trematode_kidney),
    mean_inci = mean(Trematode_kidney),
    max_inci = max(Trematode_kidney)
  )


data_parasite %>%
  group_by(population, band_number, dead) %>%
  filter(Nematode_live_all > 0) %>%
  summarise(
    N = length(Nematode_live_all),
    min_inci = min(Nematode_live_all),
    median_inci = median(Nematode_live_all),
    mean_inci = mean(Nematode_live_all),
    max_inci = max(Nematode_live_all)
  )


data_parasite %>%
  group_by(population, band_number, dead) %>%
  filter(Nematode_encaps_all > 0) %>%
  summarise(
    N = length(Nematode_encaps_all),
    min_inci = min(Nematode_encaps_all),
    median_inci = median(Nematode_encaps_all),
    mean_inci = mean(Nematode_encaps_all),
    max_inci = max(Nematode_encaps_all)
  )

data_parasite %>%
  group_by(population, band_number, dead) %>%
  filter(Acari_live_all > 0) %>%
  summarise(
    N = length(Acari_live_all),
    min_inci = min(Acari_live_all),
    median_inci = median(Acari_live_all),
    mean_inci = mean(Acari_live_all),
    max_inci = max(Acari_live_all)
  )

data_parasite %>%
  group_by(population, band_number, dead) %>%
  filter(Acari_encaps > 0) %>%
  summarise(
    N = length(Acari_encaps),
    min_inci = min(Acari_encaps),
    median_inci = median(Acari_encaps),
    mean_inci = mean(Acari_encaps),
    max_inci = max(Acari_encaps)
  )
```


# S3 - pairwise posterior comparisons for each trait

# S4 -  Posterior proportion of total variance associated with fixed effects vs. random effects in movement and food intake

Both movement behaviour and food intake were observed twice, which allows us to partition variance into among-individual and within-individual components. We show that although in both cases, within-individual/"residual" variation is the dominant component, there is a non-negligible among-individual variance component: both traits are repeatable (**Supporting Information Figure SX**).

```{r fig-varpart}
## the variables used to fit models are scaled
## but that's not a problem since we are plotting **relative** variance components here

## in each case there are four variance components: 
## the fixed effects, the individual-level random effects, 
## the experimental session random effects, and the residual within-individual variation


## here for the movement model
varcomps_mvt <- tibble(
  VF = rowVars(posterior_linpred(mod_multi, re_formula = NA, resp = "scalemvt")),
  VI = VarCorr(mod_multi, summary = FALSE)$fullID$sd[, "scalemvt_Intercept"]^2,
  Vseries = VarCorr(mod_multi, summary = FALSE)$series$sd[, "scalemvt_Intercept"]^2,
  VR = (posterior_samples(mod_multi, pars = "sigma_scalemvt")[, 1])^2
) %>%
  mutate(
    trait = "mvt",
    VP = VF + VI + Vseries + VR
  )

## and here for the food intake model
varcomps_food <- tibble(
  VF = rowVars(posterior_linpred(mod_multi, re_formula = NA, resp = "scalefood")),
  VI = VarCorr(mod_multi, summary = FALSE)$fullID$sd[, "scalefood_Intercept"]^2,
  Vseries = VarCorr(mod_multi, summary = FALSE)$series$sd[, "scalefood_Intercept"]^2,
  VR = (posterior_samples(mod_multi, pars = "sigma_scalefood")[, 1])^2
) %>%
  mutate(
    trait = "food",
    VP = VF + VI + Vseries + VR
  )

## we merge them and do some rearranging/ renaming
varcomps <- rbind(varcomps_food, varcomps_mvt) %>%
  group_by(trait) %>%
  pivot_longer(cols = c(VF, VI, Vseries, VR), names_to = "varcomp", values_to = "variance") %>%
  ungroup() %>%
  mutate(varcomp = fct_recode(varcomp,
    `fixed effects` = "VF",
    individual = "VI",
    `test group` = "Vseries",
    residuals = "VR"
  )) %>%
  mutate(varcomp = fct_relevel(varcomp, rev)) %>%
  mutate(varcomp = fct_relevel(varcomp, "test group", after = 1)) %>%
  mutate(trait = fct_recode(trait,
    `Food intake` = "food",
    `Movement speed` = "mvt"
  ))

## and then we plot

ggplot() +
  stat_halfeye(aes(y = varcomp, x = 100 * variance / VP),
    point_interval = mean_hdi, .width = c(0.001, 0.95),
    normalize = "xy"
  ) +
  facet_wrap(~trait) +
  scale_x_continuous(
    name = "Variance explained (%, observed scale)", lim = c(0, 100),
    breaks = seq(from = 0, to = 100, by = 10)
  ) +
  scale_y_discrete(name = "Variance component") +
  cowplot::theme_half_open(11) +
  cowplot::background_grid(colour.major = "grey95", colour.minor = "grey95")
```

**Supporting Information Figure SX.** Mean (points) and posteriors for the proportion of variance explained by the different variance components. See **Methods** and **Supporting Information S1** for a description of the model underlying these estimates.

# References